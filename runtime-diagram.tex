\begin{tikzpicture}[
  node distance = 1em, text height = 0.6em, text depth = 0.1em,
  minimum height = 2em,
  module/.style           = { draw, thick, rounded corners,
    fill = white, minimum height = 2.5em, inner sep = 0.5em,
    rectangle, font = {\bfseries}, align=center },
  ctl module/.style   = { module, fill=black!20 },
  edge/.style             = { black, thick },
  data edge/.style        = { edge, -> },
  ctl edge partial/.style = { edge, dashed },
  ctl edge/.style         = { ctl edge partial, -> },
  label/.style            = { text centered, font={\itshape}}
  ]

  \node [module]         (source)                          { Source };
  \node [ctl module] (degrade)   [right=of source]     { Degrade };
  \node [ctl module] (queue)     [right=of degrade]    { Queue };
  \node [ctl module] (socket)    [right=of queue]      { Socket };
  \node [ctl module] (receiver)  [right=5em of socket] { Receiver }
  (receiver.west) edge [<-, edge] node [auto, swap, label, yshift=-.4em] {data} (socket.east);
  \node [module]         (analytics) [right=of receiver]   { Analytics };
  \node [ctl module] (cc) [below=2em of queue, xshift=1.8em] {Congestion
    Controller};

  \draw [data edge] (source)    to (degrade);
  \draw [data edge] (degrade)   to (queue);
  \draw [data edge] (queue)     to (socket);
  \draw [data edge] (receiver)  to (analytics);

  \draw [ctl edge] (queue.south) to (queue.south |- cc.north);
  \draw [ctl edge] (socket.south) to (socket.south |- cc.north);
  \draw [ctl edge partial] (cc.west) to (cc.west -| degrade.south);
  \draw [ctl edge] (cc.west -| degrade.south) to (degrade.south);

  \node [] (client) [below=4em of source] {Edge (Client)};
  \node [] (server) [below=1em of analytics] {Server};

  %%
  %% Background box
  %%
  \begin{scope}[on background layer]
    \coordinate (top right) at ($(socket.north east) + (.5em, 1em)$);

    \node [draw, thick, fill=white,
    double copy shadow={shadow xshift=2pt, shadow yshift=-2pt, fill=white, draw},
    fit = (top right) (client)] {};
  \end{scope}

  \begin{scope}[on background layer]
    \coordinate (top left) at ($(receiver.north west) + (-.5em, 1em)$);
    \coordinate (top right) at ($(analytics.north east) + (.5em, 1em)$);

    \node [draw, thick, fill=white, fit = (top left) (top right) (server)] {};
  \end{scope}

  %%
  %% Legend
  %%
  \begin{scope}[shift={($(receiver.south) + (-5em, -6em)$)},
    node distance = 0.2em]
    \draw [data edge] (0, 0) to (2em, 0) node [] (data edge) {};
    \node [] (data legend) [right=of data edge] {Data Plane};

    \draw [ctl edge] (0, -2em) to (2em, -2em) node [] (control edge) {};
    \node [] (control legend) [right=of control edge] {Control Plane};

    \node [module, minimum width=3em, minimum height=1em] (app) [right=7em of data legend.west] {};
    \node [] [right=of app] {Application};

    \node [ctl module, minimum width=3em, minimum height=1em] (sys) [right=7em of control legend.west] {};
    \node [] [right=of sys] {System};
  \end{scope}

  % \coordinate (legend) at ($(receiver.south) + (-3em, -6em)$);
\end{tikzpicture}

%%% Local Variables:
%%% mode: latex
%%% TeX-master: "sosp17"
%%% End:
